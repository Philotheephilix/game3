<!doctype html>

<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      
      /* Home Screen Styles */
      #home-screen {
        min-height: 100vh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      
      #home-screen.hidden {
        display: none;
      }
      
      .background-container {
        position: fixed;
        inset: 0;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        width: 100vw;
        height: 100vh;
        background-image: url('/harvest-heist-bg.gif');
      }
      
      .content-container {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 48px;
        padding: 16px;
      }
      
      .title-container {
        text-align: center;
        margin-bottom: 32px;
      }
      
      .title {
        font-size: 6rem;
        font-weight: bold;
        color: white;
        margin-bottom: 8px;
        font-family: 'Press Start 2P', cursive;
        text-shadow: 6px 6px 0px rgba(0, 0, 0, 0.9), 12px 12px 0px rgba(255, 215, 0, 0.4);
        letter-spacing: 4px;
      }
      
      .subtitle {
        color: white;
        margin-top: 16px;
        font-family: 'Press Start 2P', cursive;
        text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.8);
        font-size: 12px;
        letter-spacing: 2px;
      }
      
      .buttons-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
        width: 100%;
        max-width: 384px;
      }
      
      .pixel-button {
        padding: 16px 32px;
        width: 100%;
        font-weight: bold;
        color: white;
        border: 4px solid #1f2937;
        border-radius: 8px;
        transition: all 150ms transform;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        letter-spacing: 1px;
        text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 -4px 0 rgba(0, 0, 0, 0.4);
      }
      
      .pixel-button:hover {
        transform: scale(1.05) translateY(-4px);
        filter: brightness(1.1);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5), inset 0 -4px 0 rgba(0, 0, 0, 0.4);
      }
      
      .pixel-button:active {
        transform: scale(0.95);
      }
      
      .pixel-button.amber {
        background: linear-gradient(to bottom, #fbbf24, #d97706);
      }
      
      .pixel-button.green {
        background: linear-gradient(to bottom, #4ade80, #16a34a);
      }
      
      .pixel-button.purple {
        background: linear-gradient(to bottom, #a78bfa, #9333ea);
      }
      
      /* Old Styles for Game Interface */
      #game-interface {
        padding: 20px;
      }
      
      #game-interface.hidden {
        display: none;
      }
      
      .section {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
      }
      .section h2 {
        margin-top: 0;
      }
      .input-group {
        margin: 10px 0;
      }
      .input-group input {
        margin-right: 10px;
        padding: 5px;
      }
      button {
        margin: 5px;
        padding: 8px 15px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      /* Safe Area Menu Modal */
      #safe-area-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      #safe-area-modal.show {
        display: flex;
      }

      .safe-area-content {
        background: white;
        padding: 24px;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .safe-area-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e5e7eb;
      }

      .safe-area-header h2 {
        margin: 0;
        font-family: 'Press Start 2P', cursive;
        font-size: 18px;
      }

      .close-button {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
      }

      .close-button:hover {
        background: #dc2626;
      }

      .safe-area-info {
        margin-bottom: 20px;
        padding: 12px;
        background: #f3f4f6;
        border-radius: 4px;
      }

      .safe-area-assets {
        margin-top: 20px;
      }

      .asset-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 8px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
      }

      .asset-info {
        flex: 1;
      }

      .asset-info strong {
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
      }

      .secure-button {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
      }

      .secure-button:hover {
        background: #059669;
      }

      .secure-button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .title {
          font-size: 3rem;
        }
        .subtitle {
          font-size: 10px;
        }
        .pixel-button {
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Home Screen -->
    <div id="home-screen">
      <div class="background-container"></div>
      <div class="content-container">
        <div class="title-container">
          <h1 class="title">HARVEST HEIST</h1>
          <p class="subtitle">STEAL THE CROPS</p>
        </div>
        
        <div class="buttons-container">
          <button class="pixel-button amber" id="play-game-button">PLAY GAME</button>
          <button class="pixel-button green" id="join-button">JOIN</button>
          <button class="pixel-button purple" id="leaderboard-button">LEADERBOARD</button>
        </div>
      </div>
    </div>

    <!-- Game Interface (hidden by default) -->
    <div id="game-interface" class="hidden">
      <h1>Game System</h1>

      <button id="controller-button">Connect</button>

      <div>
        <!-- Original Spawn/Move Section -->
        <div class="section">
          <h2>Player Movement</h2>
          <div id="position-display" class="display">Position: (0, 0)</div>
          <div id="moves-display" class="display">Moves remaining: 0</div>

          <button id="spawn-button" disabled>Spawn</button>
          <button id="move-random-button" disabled>Move random</button>
          <div>
            <button id="up-button" disabled>Up</button>
            <button id="down-button" disabled>Down</button>
            <button id="left-button" disabled>Left</button>
            <button id="right-button" disabled>Right</button>
          </div>
        </div>

        <!-- Game System Section -->
        <div class="section">
          <h2>Game System</h2>
          
          <div class="input-group">
            <h3>Create World</h3>
            <input type="number" id="create-world-id-input" placeholder="World ID" value="1" />
            <button id="create-world-button" disabled>Create World</button>
          </div>

          <div class="input-group">
            <h3>Create Game</h3>
            <input type="number" id="world-id-input" placeholder="World ID" value="1" />
            <button id="create-game-button" disabled>Create Game</button>
          </div>

          <div class="input-group">
            <h3>Join Game</h3>
            <input type="number" id="join-game-id-input" placeholder="Game ID" value="1" />
            <button id="join-game-button" disabled>Join Game</button>
          </div>

          <div class="input-group">
            <h3>Start Game</h3>
            <input type="number" id="start-game-id-input" placeholder="Game ID" value="1" />
            <button id="start-game-button" disabled>Start Game</button>
          </div>

          <div class="input-group">
            <h3>Collect Asset</h3>
            <input type="number" id="collect-game-id-input" placeholder="Game ID" value="1" />
            <input type="number" id="asset-id-input" placeholder="Asset ID" value="1" />
            <button id="collect-asset-button" disabled>Collect Asset</button>
          </div>

          <div class="input-group">
            <h3>Enter Safe Area</h3>
            <input type="number" id="safe-area-game-id-input" placeholder="Game ID" value="1" />
            <button id="enter-safe-area-button" disabled>Enter Safe Area</button>
          </div>

          <div class="input-group">
            <h3>Move Player</h3>
            <input type="number" id="move-game-id-input" placeholder="Game ID" value="1" />
            <input type="number" id="pos-x-input" placeholder="X" value="0" />
            <input type="number" id="pos-y-input" placeholder="Y" value="0" />
            <button id="move-player-button" disabled>Move Player</button>
          </div>

          <div class="input-group">
            <h3>Hit</h3>
            <input type="number" id="hit-game-id-input" placeholder="Game ID" value="1" />
            <input type="number" id="participant-input" placeholder="Participant (0/1)" value="0" />
            <input type="number" id="hit-amount-input" placeholder="Damage" value="10" />
            <button id="hit-button" disabled>Hit</button>
          </div>

          <div class="input-group">
            <h3>End Game</h3>
            <input type="number" id="end-game-id-input" placeholder="Game ID" value="1" />
            <button id="end-game-button" disabled>End Game</button>
          </div>
        </div>

        <!-- Torii Query Section -->
        <div class="section">
          <h2>Torii Queries</h2>
          
          <div class="input-group">
            <button id="query-worlds-button" disabled>Query Worlds</button>
          </div>

          <div class="input-group">
            <button id="query-games-button" disabled>Query All Games</button>
          </div>

          <div class="input-group">
            <h3>Query Collected Assets</h3>
            <input type="number" id="query-game-id-input" placeholder="Game ID" value="1" />
            <button id="query-collected-assets-button" disabled>Query Collected Assets</button>
          </div>

          <div class="input-group">
            <h3>Query Permanent Assets</h3>
            <input type="number" id="query-permanent-game-id-input" placeholder="Game ID" value="1" />
            <button id="query-permanent-assets-button" disabled>Query Permanent Assets</button>
          </div>

          <div class="input-group">
            <button id="query-player-assets-button" disabled>Query My Player Assets</button>
          </div>

          <pre id="torii-result-display" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; max-height: 400px; overflow: auto; font-size: 12px;">Query results will appear here...</pre>
        </div>

        <div style="margin-top: 20px;">
          <a href="https://book.dojoengine.org/" target="_blank" rel="noopener noreferrer">Dojo Documentation</a>
        </div>
      </div>
    </div>

    <!-- Safe Area Menu Modal -->
    <div id="safe-area-modal">
      <div class="safe-area-content">
        <div class="safe-area-header">
          <h2>SAFE AREA</h2>
          <button class="close-button" id="close-safe-area-modal">CLOSE</button>
        </div>
        <div class="safe-area-info">
          <p>Securely store your collected assets here. Assets stored in the safe area cannot be stolen by other players.</p>
        </div>
        <div class="safe-area-assets" id="safe-area-assets-list">
          <p>Loading your collected assets...</p>
        </div>
      </div>
    </div>

    <script type="module">
      import Controller from '@cartridge/controller';
      import { init, ToriiQueryBuilder, KeysClause } from '@dojoengine/sdk';

      import controllerOpts from './controller.ts';
      import { initGame, updateFromEntitiesData, queryWorlds } from './game.ts';

      import manifest from '../contracts/manifest_dev.json' assert { type: 'json' };

      const DOMAIN_SEPERATOR = {
        name: 'dojo-intro',
        version: '1.0',
        chainId: 'KATANA',
        revision: '1',
      };

      let toriiClient = null;

      async function run(account) {
        const torii = await init({
          client: {
            worldAddress: manifest.world.address,
            toriiUrl: 'https://api.cartridge.gg/x/harvest/torii',
          },
          domain: DOMAIN_SEPERATOR,
        });

        toriiClient = torii;

        initGame(account, manifest, toriiClient);

        // Setup Torii query button
        // query-worlds-button is handled in initGame

        // Subscribe to model updates
        const [_, subscription] = await torii.subscribeEntityQuery({
          query: new ToriiQueryBuilder().withClause(
            KeysClause(['di-Position', 'di-Moves'], [account.address], 'FixedLen').build(),
          ),
          callback: ({ data, error }) => {
            if (data) {
              updateFromEntitiesData(data);
            }
            if (error) {
              console.error(error);
            }
          },
        });

        // Unsubscribe on window exit
        window.addEventListener('beforeunload', () => {
          if (subscription) {
            subscription.cancel();
          }
        });
      }

      const controller = new Controller(controllerOpts);

      // Home screen button handlers
      document.getElementById('play-game-button').onclick = () => {
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('game-interface').classList.remove('hidden');
        // Auto-connect when Play Game is clicked
        document.getElementById('controller-button').click();
      };

      document.getElementById('join-button').onclick = () => {
        console.log('Join button clicked');
        // TODO: Implement join functionality
        alert('Join functionality coming soon!');
      };

      document.getElementById('leaderboard-button').onclick = () => {
        console.log('Leaderboard button clicked');
        // TODO: Implement leaderboard functionality
        alert('Leaderboard functionality coming soon!');
      };

      // Safe Area Menu Functions
      function openSafeAreaMenu(gameId) {
        console.log('[SAFE AREA] Opening menu for game:', gameId);
        const modal = document.getElementById('safe-area-modal');
        if (modal) {
          modal.classList.add('show');
          
          // Load and display collected assets
          loadSafeAreaAssets(gameId);
        } else {
          console.error('[SAFE AREA] Modal element not found!');
        }
      }

      // Expose function to window so game can call it
      window.openSafeAreaMenu = openSafeAreaMenu;

      // Listen for postMessage from the game
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'OPEN_SAFE_AREA') {
          const gameId = event.data.gameId || '1';
          openSafeAreaMenu(gameId);
        }
      });

      function closeSafeAreaMenu() {
        const modal = document.getElementById('safe-area-modal');
        if (modal) {
          modal.classList.remove('show');
          
          // Notify the game that the menu was closed so it can reset the flag
          if (typeof window !== 'undefined') {
            window.postMessage({ type: 'CLOSE_SAFE_AREA' }, '*');
          }
        }
      }

      async function loadSafeAreaAssets(gameId) {
        const assetsList = document.getElementById('safe-area-assets-list');
        assetsList.innerHTML = '<p>Loading assets...</p>';
        
        try {
          // Query collected assets for this game
          const query = `
            query GetCollectedAssets {
              diCollectedAssetModels {
                edges {
                  node {
                    game_id
                    asset_id
                    collection_index
                    participant
                  }
                }
              }
            }
          `;

          const response = await fetch('https://api.cartridge.gg/x/harvest/torii/graphql', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query }),
          });

          const result = await response.json();
          
          if (result.errors) {
            assetsList.innerHTML = `<p style="color: red;">Error: ${result.errors.map(e => e.message).join(', ')}</p>`;
            return;
          }

          if (!result.data || !result.data.diCollectedAssetModels) {
            assetsList.innerHTML = '<p>No assets data available.</p>';
            return;
          }

          // Filter assets by game_id and exclude deleted markers
          const gameIdStr = String(gameId);
          const allAssets = result.data.diCollectedAssetModels.edges.map(edge => edge.node);
          const assets = allAssets.filter(asset => 
            String(asset.game_id) === gameIdStr && asset.participant !== 255
          );

          if (assets.length === 0) {
            assetsList.innerHTML = '<p>No collected assets found for this game.</p>';
            return;
          }

          // Group assets by asset_id and count
          const assetCounts = {};
          assets.forEach(asset => {
            if (!assetCounts[asset.asset_id]) {
              assetCounts[asset.asset_id] = {
                asset_id: asset.asset_id,
                count: 0,
                participant: asset.participant
              };
            }
            assetCounts[asset.asset_id].count++;
          });

          // Display assets
          assetsList.innerHTML = '';
          Object.values(assetCounts).forEach(asset => {
            const assetItem = document.createElement('div');
            assetItem.className = 'asset-item';
            assetItem.innerHTML = `
              <div class="asset-info">
                <strong>Asset ID:</strong> ${asset.asset_id}<br>
                <span>Quantity: ${asset.count}</span>
              </div>
              <button class="secure-button" onclick="secureAsset('${gameId}', '${asset.asset_id}')">
                SECURE
              </button>
            `;
            assetsList.appendChild(assetItem);
          });

          // Make secureAsset function available globally
          window.secureAsset = async function(gId, aId) {
            // This will be called from initGame when account is available
            console.log('Secure asset:', gId, aId);
            alert(`Securing asset ${aId} in game ${gId}. This will call enterSafeArea.`);
          };

        } catch (error) {
          console.error('Error loading assets:', error);
          assetsList.innerHTML = `<p style="color: red;">Error loading assets: ${error.message}</p>`;
        }
      }

      // Close modal handlers
      document.getElementById('close-safe-area-modal').onclick = closeSafeAreaMenu;
      
      // Close modal when clicking outside
      document.getElementById('safe-area-modal').onclick = (e) => {
        if (e.target.id === 'safe-area-modal') {
          closeSafeAreaMenu();
        }
      };

      // Handler for Enter Safe Area button - open the menu
      // Set up after DOM is ready and after initGame potentially runs
      function setupSafeAreaButtonHandler() {
        const enterSafeAreaButton = document.getElementById('enter-safe-area-button');
        if (enterSafeAreaButton && !enterSafeAreaButton.hasAttribute('data-safe-area-handler')) {
          enterSafeAreaButton.setAttribute('data-safe-area-handler', 'true');
          
          // Add click listener to open menu (runs first)
          enterSafeAreaButton.addEventListener('click', function(e) {
            if (this.disabled) return;
            
            const gameIdInput = document.getElementById('safe-area-game-id-input');
            const gameId = gameIdInput?.value || '1';
            
            // Open the safe area menu
            openSafeAreaMenu(gameId);
          }, { capture: true }); // Use capture to run before other handlers
        }
      }

      // Set up handler
      setupSafeAreaButtonHandler();
      
      // Also set up after a delay to catch it if initGame modifies it
      setTimeout(setupSafeAreaButtonHandler, 500);

      document.getElementById('controller-button').onclick = async () => {
        try {
          let account = await controller.connect();

          document.getElementById('controller-button').textContent = 'Connected';
          document.getElementById('controller-button').style.backgroundColor = '#4CAF50';
          
          // Enable all buttons
          const buttons = document.querySelectorAll('button:disabled');
          buttons.forEach(btn => {
            if (btn.id !== 'controller-button') {
              btn.disabled = false;
            }
          });

          run(account).catch((error) => {
            console.error(error);
          });
        } catch (error) {
          console.error('Failed to connect:', error);
          document.getElementById('controller-button').textContent = 'Connection Failed';
          document.getElementById('controller-button').style.backgroundColor = '#f44336';
        }
      };
    </script>
  </body>
</html>
